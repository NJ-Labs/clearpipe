apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "clearpipe.fullname" . }}-config
  labels:
    {{- include "clearpipe.labels" . | nindent 4 }}
data:
  api-external-url: {{ .Values.ingress.hosts | first | .host | default "http://localhost:8000" | quote }}
  site-url: {{ .Values.ingress.hosts | first | .host | default "http://localhost:3000" | quote }}
---
{{- if .Values.kong.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "clearpipe.fullname" . }}-kong
  labels:
    {{- include "clearpipe.labels" . | nindent 4 }}
    app.kubernetes.io/component: kong
data:
  kong.yml: |
    _format_version: "2.1"
    _transform: true

    consumers:
      - username: anon
        keyauth_credentials:
          - key: "{{`{{ .Values.supabase.anonKey }}`}}"
      - username: service_role
        keyauth_credentials:
          - key: "{{`{{ .Values.supabase.serviceRoleKey }}`}}"

    acls:
      - consumer: anon
        group: anon
      - consumer: service_role
        group: admin

    services:
      - name: auth-v1-open
        url: http://{{ .Values.auth.name }}:{{ .Values.auth.service.port }}/verify
        routes:
          - name: auth-v1-open
            strip_path: true
            paths:
              - /auth/v1/verify
        plugins:
          - name: cors
      - name: auth-v1-open-callback
        url: http://{{ .Values.auth.name }}:{{ .Values.auth.service.port }}/callback
        routes:
          - name: auth-v1-open-callback
            strip_path: true
            paths:
              - /auth/v1/callback
        plugins:
          - name: cors
      - name: auth-v1-open-authorize
        url: http://{{ .Values.auth.name }}:{{ .Values.auth.service.port }}/authorize
        routes:
          - name: auth-v1-open-authorize
            strip_path: true
            paths:
              - /auth/v1/authorize
        plugins:
          - name: cors
      - name: auth-v1
        url: http://{{ .Values.auth.name }}:{{ .Values.auth.service.port }}
        routes:
          - name: auth-v1
            strip_path: true
            paths:
              - /auth/v1/
        plugins:
          - name: cors
          - name: key-auth
            config:
              hide_credentials: false
      - name: rest-v1
        url: http://{{ .Values.rest.name }}:{{ .Values.rest.service.port }}/
        routes:
          - name: rest-v1
            strip_path: true
            paths:
              - /rest/v1/
        plugins:
          - name: cors
          - name: key-auth
            config:
              hide_credentials: false
      - name: realtime-v1-ws
        url: http://{{ .Values.realtime.name }}:{{ .Values.realtime.service.port }}/socket
        routes:
          - name: realtime-v1-ws
            strip_path: true
            paths:
              - /realtime/v1/websocket
        plugins:
          - name: cors
          - name: key-auth
            config:
              hide_credentials: false
      - name: realtime-v1
        url: http://{{ .Values.realtime.name }}:{{ .Values.realtime.service.port }}/api
        routes:
          - name: realtime-v1
            strip_path: true
            paths:
              - /realtime/v1/
        plugins:
          - name: cors
          - name: key-auth
            config:
              hide_credentials: false
      - name: storage-v1
        url: http://{{ .Values.storage.name }}:{{ .Values.storage.service.port }}/
        routes:
          - name: storage-v1
            strip_path: true
            paths:
              - /storage/v1/
        plugins:
          - name: cors
          - name: key-auth
            config:
              hide_credentials: false
      {{- if .Values.meta.enabled }}
      - name: meta
        url: http://{{ .Values.meta.name }}:{{ .Values.meta.service.port }}/
        routes:
          - name: meta
            strip_path: true
            paths:
              - /pg/
        plugins:
          - name: key-auth
            config:
              hide_credentials: false
      {{- end }}

    plugins:
      - name: cors
        config:
          origins:
            - "*"
          methods:
            - GET
            - POST
            - PUT
            - PATCH
            - DELETE
            - OPTIONS
          headers:
            - Accept
            - Accept-Version
            - Authorization
            - Content-Length
            - Content-MD5
            - Content-Type
            - Date
            - X-Auth-Token
            - X-Client-Info
            - apikey
            - x-upsert
            - prefer
            - range
          exposed_headers:
            - Content-Length
            - Content-Range
            - X-Supabase-Api-Version
          credentials: true
          max_age: 3600
{{- end }}
