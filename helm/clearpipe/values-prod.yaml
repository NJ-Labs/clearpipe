# ============================================================
# ClearPipe Helm Values - Production Environment
# ============================================================
# Override values for production Kubernetes clusters
# Usage: helm install clearpipe ./helm/clearpipe -f ./helm/clearpipe/values-prod.yaml
# ============================================================

# App configuration
app:
  replicaCount: 3
  
  resources:
    requests:
      cpu: "200m"
      memory: "512Mi"
    limits:
      cpu: "1000m"
      memory: "1Gi"
  
  autoscaling:
    enabled: true
    minReplicas: 3
    maxReplicas: 20
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80
  
  podDisruptionBudget:
    enabled: true
    minAvailable: 2
  
  # Production-grade probes
  livenessProbe:
    httpGet:
      path: /api/health
      port: 3000
    initialDelaySeconds: 30
    periodSeconds: 15
    timeoutSeconds: 10
    failureThreshold: 5
  
  readinessProbe:
    httpGet:
      path: /api/health
      port: 3000
    initialDelaySeconds: 15
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3
  
  # Anti-affinity to spread pods across nodes
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchLabels:
                app.kubernetes.io/name: clearpipe-app
            topologyKey: kubernetes.io/hostname

# Nginx
nginx:
  replicaCount: 3
  resources:
    requests:
      cpu: "100m"
      memory: "128Mi"
    limits:
      cpu: "500m"
      memory: "256Mi"

# Ingress for production
ingress:
  enabled: true
  className: nginx
  annotations:
    nginx.ingress.kubernetes.io/proxy-body-size: "100m"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "60"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    # Enable cert-manager for automatic TLS
    cert-manager.io/cluster-issuer: letsencrypt-prod
    # Rate limiting
    nginx.ingress.kubernetes.io/limit-rps: "50"
    nginx.ingress.kubernetes.io/limit-connections: "20"
  hosts:
    - host: clearpipe.yourdomain.com
      paths:
        - path: /
          pathType: Prefix
          service: app
        - path: /rest/v1
          pathType: Prefix
          service: kong
        - path: /auth/v1
          pathType: Prefix
          service: kong
        - path: /storage/v1
          pathType: Prefix
          service: kong
        - path: /realtime/v1
          pathType: Prefix
          service: kong
  tls:
    - secretName: clearpipe-tls
      hosts:
        - clearpipe.yourdomain.com

# Kong
kong:
  replicaCount: 3
  resources:
    requests:
      cpu: "200m"
      memory: "512Mi"
    limits:
      cpu: "1000m"
      memory: "1Gi"

# Auth
auth:
  replicaCount: 3
  resources:
    requests:
      cpu: "100m"
      memory: "256Mi"
    limits:
      cpu: "500m"
      memory: "512Mi"
  env:
    GOTRUE_MAILER_AUTOCONFIRM: "false"
    GOTRUE_DISABLE_SIGNUP: "false"

# PostgREST
rest:
  replicaCount: 3
  resources:
    requests:
      cpu: "100m"
      memory: "256Mi"
    limits:
      cpu: "500m"
      memory: "512Mi"

# Realtime
realtime:
  replicaCount: 3
  resources:
    requests:
      cpu: "200m"
      memory: "512Mi"
    limits:
      cpu: "1000m"
      memory: "1Gi"

# Storage
storage:
  replicaCount: 2
  resources:
    requests:
      cpu: "100m"
      memory: "256Mi"
    limits:
      cpu: "500m"
      memory: "512Mi"
  persistence:
    enabled: true
    size: 50Gi
    storageClass: "fast-ssd"  # Use appropriate storage class

# Meta
meta:
  replicaCount: 2
  resources:
    requests:
      cpu: "100m"
      memory: "128Mi"
    limits:
      cpu: "300m"
      memory: "256Mi"

# Studio - Disabled in production
studio:
  enabled: false

# PostgreSQL - Production configuration
postgresql:
  architecture: replication  # Enable replication for HA
  
  primary:
    persistence:
      enabled: true
      size: 100Gi
      storageClass: "fast-ssd"
    resources:
      requests:
        cpu: "500m"
        memory: "1Gi"
      limits:
        cpu: "2000m"
        memory: "4Gi"
  
  readReplicas:
    replicaCount: 2
    persistence:
      enabled: true
      size: 100Gi
      storageClass: "fast-ssd"
    resources:
      requests:
        cpu: "250m"
        memory: "512Mi"
      limits:
        cpu: "1000m"
        memory: "2Gi"
  
  metrics:
    enabled: true

# Redis - Enable for production caching
redis:
  enabled: true
  architecture: replication
  
  auth:
    enabled: true
  
  master:
    persistence:
      enabled: true
      size: 5Gi
      storageClass: "fast-ssd"
    resources:
      requests:
        cpu: "200m"
        memory: "256Mi"
      limits:
        cpu: "500m"
        memory: "512Mi"
  
  replica:
    replicaCount: 2
    persistence:
      enabled: true
      size: 5Gi
    resources:
      requests:
        cpu: "100m"
        memory: "128Mi"
      limits:
        cpu: "250m"
        memory: "256Mi"

# ImgProxy
imgproxy:
  replicaCount: 2
  resources:
    requests:
      cpu: "200m"
      memory: "512Mi"
    limits:
      cpu: "1000m"
      memory: "1Gi"

# Enable network policies for production
networkPolicy:
  enabled: true

# Strict security context for production
podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1001
  fsGroup: 1001

securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
      - ALL
  readOnlyRootFilesystem: true
  runAsNonRoot: true
  runAsUser: 1001
